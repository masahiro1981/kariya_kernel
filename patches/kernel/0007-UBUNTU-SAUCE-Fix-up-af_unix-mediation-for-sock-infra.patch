From 04b08a838223bde38fc6ef11db5158d3338726d7 Mon Sep 17 00:00:00 2001
From: John Johansen <john.johansen@canonical.com>
Date: Mon, 18 Mar 2019 16:15:04 -0700
Subject: [PATCH 07/31] UBUNTU: SAUCE: Fix-up af_unix mediation for sock
 infrastructure management

Signed-off-by: John Johansen <john.johansen@canonical.com>
Signed-off-by: Seth Forshee <seth.forshee@canonical.com>
---
 security/apparmor/af_unix.c | 14 +++++++-------
 security/apparmor/lsm.c     | 12 ++++++------
 2 files changed, 13 insertions(+), 13 deletions(-)

diff --git a/security/apparmor/af_unix.c b/security/apparmor/af_unix.c
index 54b3796f63d0..154dfac35f97 100644
--- a/security/apparmor/af_unix.c
+++ b/security/apparmor/af_unix.c
@@ -22,7 +22,7 @@
 #include "include/policy.h"
 #include "include/cred.h"
 
-static inline struct sock *aa_sock(struct unix_sock *u)
+static inline struct sock *aa_unixsock(struct unix_sock *u)
 {
 	return &u->sk;
 }
@@ -32,7 +32,7 @@ static inline int unix_fs_perm(const char *op, u32 mask, struct aa_label *label,
 {
 	AA_BUG(!label);
 	AA_BUG(!u);
-	AA_BUG(!UNIX_FS(aa_sock(u)));
+	AA_BUG(!UNIX_FS(aa_unixsock(u)));
 
 	if (unconfined(label) || !LABEL_MEDIATES(label, AA_CLASS_FILE))
 		return 0;
@@ -46,7 +46,7 @@ static inline int unix_fs_perm(const char *op, u32 mask, struct aa_label *label,
 		/* socket path has been cleared because it is being shutdown
 		 * can only fall back to original sun_path request
 		 */
-		struct aa_sk_ctx *ctx = SK_CTX(&u->sk);
+		struct aa_sk_ctx *ctx = aa_sock(&u->sk);
 		if (ctx->path.dentry)
 			return aa_path_perm(op, label, &ctx->path, flags, mask,
 					    &cond);
@@ -512,7 +512,7 @@ static int profile_peer_perm(struct aa_profile *profile, const char *op, u32 req
 
 	state = PROFILE_MEDIATES_AF(profile, AF_UNIX);
 	if (state) {
-		struct aa_sk_ctx *peer_ctx = SK_CTX(peer_sk);
+		struct aa_sk_ctx *peer_ctx = aa_sock(peer_sk);
 		struct aa_profile *peerp;
 		struct sockaddr_un *addr = NULL;
 		int len = 0;
@@ -547,9 +547,9 @@ int aa_unix_peer_perm(struct aa_label *label, const char *op, u32 request,
 	AA_BUG(!sk);
 	AA_BUG(!peer_sk);
 
-	if (UNIX_FS(aa_sock(peeru)))
+	if (UNIX_FS(aa_unixsock(peeru)))
 		return unix_fs_perm(op, request, label, peeru, 0);
-	else if (UNIX_FS(aa_sock(u)))
+	else if (UNIX_FS(aa_unixsock(u)))
 		return unix_fs_perm(op, request, label, u, 0);
 	else {
 		struct aa_profile *profile;
@@ -632,7 +632,7 @@ int aa_unix_file_perm(struct aa_label *label, const char *op, u32 request,
 		error = unix_fs_perm(op, request, label, unix_sk(peer_sk),
 				     PATH_SOCK_COND);
 	} else {
-		struct aa_sk_ctx *pctx = SK_CTX(peer_sk);
+		struct aa_sk_ctx *pctx = aa_sock(peer_sk);
 		if (sk_req)
 			error = aa_unix_label_sk_perm(label, op, sk_req,
 						      sock->sk);
diff --git a/security/apparmor/lsm.c b/security/apparmor/lsm.c
index f0c36336e31a..e0e993e8533c 100644
--- a/security/apparmor/lsm.c
+++ b/security/apparmor/lsm.c
@@ -804,9 +804,9 @@ static struct path *UNIX_FS_CONN_PATH(struct sock *sk, struct sock *newsk)
 static int apparmor_unix_stream_connect(struct sock *sk, struct sock *peer_sk,
 					struct sock *newsk)
 {
-	struct aa_sk_ctx *sk_ctx = SK_CTX(sk);
-	struct aa_sk_ctx *peer_ctx = SK_CTX(peer_sk);
-	struct aa_sk_ctx *new_ctx = SK_CTX(newsk);
+	struct aa_sk_ctx *sk_ctx = aa_sock(sk);
+	struct aa_sk_ctx *peer_ctx = aa_sock(peer_sk);
+	struct aa_sk_ctx *new_ctx = aa_sock(newsk);
 	struct aa_label *label;
 	struct path *path;
 	int error;
@@ -863,7 +863,7 @@ static int apparmor_unix_stream_connect(struct sock *sk, struct sock *peer_sk,
  */
 static int apparmor_unix_may_send(struct socket *sock, struct socket *peer)
 {
-	struct aa_sk_ctx *peer_ctx = SK_CTX(peer->sk);
+	struct aa_sk_ctx *peer_ctx = aa_sock(peer->sk);
 	struct aa_label *label;
 	int error;
 
@@ -1122,7 +1122,7 @@ static int apparmor_socket_sock_rcv_skb(struct sock *sk, struct sk_buff *skb)
 static struct aa_label *sk_peer_label(struct sock *sk)
 {
 	struct sock *peer_sk;
-	struct aa_sk_ctx *ctx = SK_CTX(sk);
+	struct aa_sk_ctx *ctx = aa_sock(sk);
 	struct aa_label *label = ERR_PTR(-ENOPROTOOPT);
 
 	if (ctx->peer)
@@ -1136,7 +1136,7 @@ static struct aa_label *sk_peer_label(struct sock *sk)
 	 */
 	peer_sk = unix_peer_get(sk);
 	if (peer_sk) {
-		ctx = SK_CTX(peer_sk);
+		ctx = aa_sock(peer_sk);
 		if (ctx->label)
 			label = aa_get_label(ctx->label);
 		sock_put(peer_sk);
-- 
2.25.1

